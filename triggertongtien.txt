use qlbh
--drop trigger I_Total
Create trigger I_Total --trigger tính tổng tiền của bảng import_detailed = quantity*price
on Import_detailed
for Insert, update
as
begin
	update Import_detailed
	set Import_detailed.total = Import_detailed.Quantity*Import_detailed.price
	from Import_detailed join inserted i on i.ImID = Import_detailed.ImID and i.proID = Import_detailed.proID	
end

go

Create trigger trg_Odetail_Total --trigger tính tổng tiền của bảng Order_detail = quantity*price
on Order_detail 
for Insert, update
as
begin
	update Order_detail
	set Order_detail.total = Order_detail.quantity*Order_detail.price
	from Order_detail join inserted i on i.orderID = Order_detail.orderID and i.proID = Order_detail.proID
end

go

Create trigger trg_Order_Total	-- trigger tính tổng tiền của bảng Order = sum(total) của bảng order_detail
on Order_detail
for insert, update, delete
AS
begin
  update [Order]
  SET [Order].total = (SELECT SUM(Order_detail.total)
              FROM Order_detail
              WHERE Order_detail.orderID = i.orderID)
  FROM Inserted i
  JOIN [Order]
    ON [Order].orderID = i.orderID
END
go

Create trigger trig_check_priceProduct
on PriceProduct
for insert, update
as
begin
	declare @discount money,
	@price money
	select @discount = discount from inserted
	if(@discount > ANY(select price from PriceProduct))
		begin 
		ROLLBACK TRAN
		PRINT 'Lỗi! giá giảm phải bé hơn giá của sản phẩm'
		end
	else
		PRINT 'Không có lỗi'
end
go
--trigger total bảng import detail: tổng tiền 
--triger total bảng order
--trigger total bảng order detail
--trigger discount bảng priceProduct > phải bé hơn price